<!-- templates/pages/register_bhakt.html -->
<div class="bhakt-registration-container">
  <div class="swami-side">
    <img src="/static/images/swamiji.png" alt="Swami Samarth" class="swami-img" />
  </div>

  <div class="form-side">
    <h2 class="form-heading">üôè Register Bhakt</h2>

    <form id="bhaktRegistrationForm" onsubmit="event.preventDefault(); registerBhakt();">

      <div class="form-group">
        <label class="form-label" for="name">Name:</label>
        <input class="form-control" id="name" name="name" required />
      </div>

      <div class="form-group">
        <label class="form-label" for="mobile_number">Mobile:</label>
        <input class="form-control" id="mobile_number" name="mobile_number" required pattern="[0-9]{10}" title="Enter a 10-digit mobile number" />
      </div>

      <div class="form-group">
        <label class="form-label" for="address">Address:</label>
        <input class="form-control" id="address" name="address" required />
      </div>

      <div class="form-group">
        <label class="form-label" for="gotra">Gotra:</label>
        <input class="form-control" id="gotra" name="gotra" />
      </div>

      <div class="form-group">
        <label class="form-label" for="email_address">Email:</label>
        <input class="form-control" id="email_address" name="email_address" type="email" />
      </div>

      <div class="form-group">
        <label class="form-label" for="abhishek_types">Abhishek Type(s):</label>
        <select class="form-control" id="abhishek_types" name="abhishek_types[]" multiple required size="4">
          <option value="" disabled selected hidden>Choose Abhishek Type(s)</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label" for="start_date">Start Date:</label>
        <input class="form-control" id="start_date" type="date" name="start_date" required />
      </div>

      <div class="form-group">
        <label class="form-label" for="validity_months">Validity (Months):</label>
        <input class="form-control" id="validity_months" type="number" name="validity_months" value="12" min="1" max="60" />
      </div>

      <button type="submit" class="btn-submit">Register</button>
    </form>
  </div>
</div>

<script>
  // Load Abhishek types
  fetch('/abhishek_types')
    .then(res => res.json())
    .then(types => {
      const select = document.getElementById('abhishek_types');
      select.innerHTML = '';

      const placeholder = document.createElement('option');
      placeholder.textContent = "Choose Abhishek Type(s)";
      placeholder.disabled = true;
      placeholder.selected = true;
      placeholder.hidden = true;
      select.appendChild(placeholder);

      if (types.length === 0) {
        const opt = document.createElement('option');
        opt.disabled = true;
        opt.textContent = "‚ö†Ô∏è No Abhishek Types Found";
        select.appendChild(opt);
      } else {
        types.forEach(type => {
          const opt = document.createElement('option');
          opt.value = type;
          opt.textContent = type;
          select.appendChild(opt);
        });
      }
    })
    .catch(error => {
      console.error("Error loading Abhishek types:", error);
      alert("‚ö†Ô∏è Failed to load Abhishek Types. See console.");
    });

  // Submit logic
  function registerBhakt() {
    const form = document.getElementById("bhaktRegistrationForm");
    const formData = new FormData(form);
    const selectedTypes = Array.from(document.getElementById("abhishek_types").selectedOptions).map(opt => opt.value);

    const data = {
      name: formData.get("name"),
      mobile_number: formData.get("mobile_number"),
      address: formData.get("address"),
      gotra: formData.get("gotra"),
      email_address: formData.get("email_address"),
      abhishek_types: selectedTypes,
      start_date: formData.get("start_date"),
      validity_months: formData.get("validity_months")
    };

    fetch("/bhakts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(response => {
      if (response.success) {
        alert("‚úÖ Bhakt Registered!");
        form.reset();
        document.getElementById("abhishek_types").selectedIndex = -1;
      } else {
        alert("‚ùå Error: " + response.error);
      }
    })
    .catch(error => {
      console.error("Registration failed:", error);
      alert("‚ùå Something went wrong. Please try again.");
    });
  }
</script>
