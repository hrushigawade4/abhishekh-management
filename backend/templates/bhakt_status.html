<h2>ğŸ“‹ Bhakt Status</h2>

    <!-- Search Input -->
    <div style="margin-bottom: 1rem;">
      <label><strong>Search by Name or Mobile:</strong></label><br />
      <input
        type="text"
        class="search-box"
        placeholder="ğŸ” Start typing..."
        oninput="filterBhaktList(this.value)"
        style="padding: 8px; width: 300px; border-radius: 6px;"
      />
    </div>

    <!-- Bhakt Table -->
    <table id="bhaktTable" style="width: 100%; border-collapse: collapse;">
      <thead>
        <tr style="background-color: #f0f0f0;">
          <th style="padding: 8px;">Name</th>
          <th style="padding: 8px;">Mobile</th>
          <th style="padding: 8px;">Abhishek Types</th>
          <th style="padding: 8px;">Start Date</th>
          <th style="padding: 8px;">Validity</th>
          <th style="padding: 8px;">Status</th>
          <th style="padding: 8px;">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for b in bhakts %}
        <tr class="{% if b.expiration_date < current_date %}row-expired{% else %}row-active{% endif %}">
          <td style="padding: 8px;">{{ b.name }}</td>
          <td style="padding: 8px;">{{ b.mobile_number }}</td>
          <td style="padding: 8px;">{{ b.abhishek_types }}</td>
          <td style="padding: 8px;">{{ b.start_date.strftime('%Y-%m-%d') }}</td>
          <td style="padding: 8px;">{{ b.validity_months }} months</td>
          <td style="padding: 8px; font-weight: bold; color: {% if b.expiration_date >= current_date %}green{% else %}red{% endif %};">
            {% if b.expiration_date >= current_date %}
              Active
            {% else %}
              Inactive
            {% endif %}
          </td>
          <td style="padding: 8px;">
            <a href="/edit_bhakt/{{ b.id }}?next={{ request.path }}" class="action-btn edit-btn">âœï¸ Edit</a>
            <button onclick="deleteBhakt({{b.id}}, this);" class="action-btn delete-btn">ğŸ—‘ï¸ Delete</button>
            {% if b.expiration_date < current_date %}
            <button onclick="renewBhakt({{b.id}}, this);" class="action-btn renew-btn">ğŸ”„ Renew</button>
            {% endif %}
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script>
    function deleteBhakt(bhaktId, btn) {
      Swal.fire({
        title: 'Are you sure?',
        text: 'This will permanently remove the Bhakt.',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          fetch(`/delete_bhakt/${bhaktId}`)
            .then(res => res.json())
            .then(response => {
              if (response.success) {
                Swal.fire('Deleted!', 'Bhakt has been removed.', 'success');
                // Remove the row from the table
                const row = btn.closest('tr');
                if (row) row.remove();
              } else {
                Swal.fire('Error', response.error || 'Failed to delete Bhakt.', 'error');
              }
            })
            .catch(() => Swal.fire('Error', 'Failed to delete Bhakt.', 'error'));
        }
      });
    }

    function renewBhakt(bhaktId, btn) {
      Swal.fire({
        title: 'Renew Bhakt',
        text: 'Enter number of months to renew:',
        input: 'number',
        inputAttributes: {
          min: 1,
          max: 60,
          step: 1
        },
        inputValue: 12,
        showCancelButton: true,
        confirmButtonText: 'Renew'
      }).then((result) => {
        if (result.isConfirmed && result.value) {
          fetch(`/renew_bhakt/${bhaktId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ validity_months: result.value })
          })
            .then(res => res.json())
            .then(response => {
              if (response.success) {
                Swal.fire('Renewed!', 'Bhakt has been renewed.', 'success');
                setTimeout(() => location.reload(), 1000);
              } else {
                Swal.fire('Error', response.error || 'Failed to renew Bhakt.', 'error');
              }
            })
            .catch(() => Swal.fire('Error', 'Failed to renew Bhakt.', 'error'));
        }
      });
    }
  </script>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </main>

  <script>
    function filterBhaktList(query) {
      query = query.toLowerCase();
      const rows = document.querySelectorAll("#bhaktTable tbody tr");

      rows.forEach(row => {
        const name = row.cells[0].textContent.toLowerCase();
        const mobile = row.cells[1].textContent.toLowerCase();
        row.style.display = (name.includes(query) || mobile.includes(query)) ? "" : "none";
      });
    }
  </script>